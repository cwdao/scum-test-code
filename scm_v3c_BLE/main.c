// ------------------------------------------------------------------------------------------
// This flag determines whether the demo code will continuously transmit or continuously receive
// 0 = Transmit
// 1 = Receive
// Both will occur on BLE channel 37 (2.402 GHz)
unsigned int tx_rx_flag = 0;
// ------------------------------------------------------------------------------------------

#include <stdio.h>
#include <time.h>
#include <rt_misc.h>
#include <stdlib.h>
#include "Memory_map.h"
#include "Int_Handlers.h"
#include "rf_global_vars.h"
#include "scm3C_hardware_interface.h"
#include "scm3_hardware_interface.h"
#include "bucket_o_functions.h"
#include <math.h>
#include "scum_radio_bsp.h"
#include "scm_ble_functions.h"

extern unsigned int current_lfsr;

extern char send_packet[127];
extern unsigned int ASC[38];

// Bootloader will insert length and pre-calculated CRC at these memory addresses	
#define crc_value         (*((unsigned int *) 0x0000FFFC))
#define code_length       (*((unsigned int *) 0x0000FFF8))

unsigned int LC_target = 250182;
unsigned int LC_code = 840;

// HF_CLOCK tuning settings
unsigned int HF_CLOCK_fine = 17;
unsigned int HF_CLOCK_coarse = 3;

// RC 2MHz tuning settings
unsigned int RC2M_coarse = 21;
unsigned int RC2M_fine = 15;
unsigned int RC2M_superfine = 15;

// Receiver clock settings
unsigned int IF_clk_target = 1900000;
unsigned int IF_coarse = 11;
unsigned int IF_fine = 18;

unsigned int cal_iteration = 0;
unsigned int run_test_flag = 0;
unsigned int num_packets_to_test = 1;

unsigned short optical_cal_iteration = 0, optical_cal_finished = 0;

unsigned short doing_initial_packet_search;
unsigned short current_RF_channel;
unsigned short do_debug_print = 0;

char start_LC_sweep = 0;
unsigned int LC_sweep_code = 0;
unsigned int LC_monotonic_sweep_code = 0;
unsigned int LC_monotonic_sweep_index = 0;
unsigned int LC_monotonic_codes_length = 2119;
unsigned int LC_monotonic_codes[2119] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 13, 14, 15, 17, 21, 22, 29, 30, 31, 62, 90, 93, 94, 95, 126, 127, 150, 155, 157, 158, 215, 220, 221, 222, 223, 276, 277, 278, 282, 284, 287, 343, 346, 347, 377, 383, 411, 438, 443, 445, 446, 475, 479, 505, 506, 507, 508, 509, 510, 542, 543, 570, 571, 596, 597, 599, 600, 601, 634, 636, 637, 638, 639, 667, 668, 671, 693, 696, 699, 700, 701, 728, 729, 730, 731, 732, 734, 765, 766, 799, 826, 830, 857, 858, 859, 861, 862, 863, 893, 894, 895, 923, 927, 957, 958, 959, 1016, 1018, 1019, 1020, 1022, 1470, 1497, 1499, 1501, 1502, 1503, 1563, 1564, 1587, 1595, 1598, 1627, 1629, 1631, 1656, 1659, 1660, 1661, 1662, 1690, 1691, 1693, 1726, 1752, 1754, 1755, 1759, 1818, 1820, 1821, 1822, 1853, 1855, 1886, 1912, 1913, 1915, 1943, 1946, 1947, 1949, 1950, 1974, 1980, 1981, 1982, 1983, 2012, 2043, 2046, 2047, 2461, 2462, 2493, 2494, 2520, 2521, 2524, 2527, 2551, 2553, 2583, 2587, 2588, 2589, 2622, 2672, 2677, 2683, 2684, 2686, 2687, 2718, 2719, 2777, 2778, 2781, 2783, 2808, 2813, 2815, 2841, 2847, 2874, 2875, 2876, 2877, 2903, 2907, 2908, 2909, 2911, 2941, 2942, 2969, 2972, 2974, 2975, 3003, 3034, 3036, 3037, 3038, 3039, 3066, 3067, 3070, 3071, 3483, 3484, 3486, 3541, 3549, 3551, 3577, 3578, 3607, 3608, 3609, 3610, 3611, 3613, 3615, 3647, 3677, 3678, 3705, 3708, 3709, 3710, 3741, 3768, 3769, 3770, 3802, 3803, 3804, 3806, 3807, 3865, 3866, 3870, 3871, 3902, 3931, 3934, 3935, 3966, 3967, 3992, 3993, 3997, 4024, 4027, 4029, 4030, 4031, 4060, 4063, 4086, 4087, 4088, 4089, 4093, 4095, 4479, 4506, 4564, 4566, 4567, 4575, 4603, 4604, 4630, 4632, 4633, 4635, 4636, 4667, 4669, 4670, 4699, 4700, 4703, 4732, 4733, 4734, 4766, 4767, 4822, 4823, 4824, 4825, 4827, 4829, 4857, 4858, 4859, 4926, 4952, 4953, 4958, 4959, 4985, 4986, 4991, 5020, 5021, 5022, 5023, 5052, 5087, 5112, 5114, 5115, 5533, 5561, 5564, 5565, 5567, 5591, 5593, 5595, 5597, 5659, 5660, 5661, 5690, 5694, 5695, 5722, 5727, 5756, 5757, 5758, 5759, 5789, 5790, 5821, 5822, 5823, 5852, 5880, 5881, 5882, 5916, 5918, 5945, 5951, 5971, 5972, 5974, 5980, 5981, 5983, 6012, 6015, 6047, 6073, 6075, 6076, 6079, 6107, 6109, 6110, 6139, 6143, 6527, 6556, 6557, 6558, 6613, 6616, 6622, 6623, 6651, 6652, 6653, 6654, 6684, 6685, 6686, 6687, 6718, 6719, 6751, 6774, 6778, 6782, 6810, 6811, 6812, 6813, 6845, 6847, 6911, 6935, 6936, 6938, 6964, 6965, 6967, 6968, 6969, 6972, 7005, 7006, 7007, 7036, 7037, 7038, 7070, 7095, 7096, 7097, 7102, 7133, 7134, 7135, 7606, 7607, 7613, 7614, 7644, 7647, 7667, 7673, 7674, 7676, 7677, 7678, 7679, 7708, 7709, 7740, 7766, 7770, 7771, 7772, 7773, 7774, 7775, 7798, 7803, 7804, 7807, 7832, 7833, 7838, 7898, 7901, 7902, 7903, 7956, 7957, 7963, 7966, 7967, 7993, 7995, 7997, 7998, 8025, 8026, 8028, 8058, 8059, 8060, 8062, 8063, 8117, 8120, 8122, 8123, 8124, 8155, 8156, 8158, 8159, 8190, 8191, 8667, 8668, 8701, 8729, 8730, 8731, 8732, 8733, 8735, 8761, 8764, 8765, 8794, 8795, 8799, 8827, 8828, 8887, 8888, 8893, 8925, 8926, 8957, 8958, 8983, 8986, 8988, 8990, 8991, 9023, 9049, 9050, 9051, 9083, 9084, 9117, 9119, 9140, 9143, 9149, 9150, 9178, 9210, 9214, 9215, 9631, 9656, 9658, 9660, 9662, 9663, 9694, 9725, 9755, 9783, 9788, 9790, 9791, 9815, 9817, 9818, 9819, 9820, 9822, 9823, 9852, 9855, 9882, 9883, 9884, 9886, 9887, 9913, 9918, 9919, 9977, 9979, 9982, 9983, 10011, 10013, 10037, 10042, 10043, 10047, 10068, 10076, 10077, 10103, 10108, 10110, 10111, 10137, 10139, 10143, 10169, 10170, 10172, 10173, 10174, 10175, 10202, 10205, 10206, 10235, 10236, 10238, 10651, 10652, 10686, 10715, 10716, 10717, 10719, 10749, 10750, 10751, 10781, 10782, 10811, 10813, 10814, 10815, 10840, 10841, 10842, 10844, 10906, 10907, 10909, 10910, 10941, 10966, 10969, 10970, 10971, 10998, 11002, 11003, 11004, 11006, 11036, 11037, 11038, 11097, 11103, 11126, 11127, 11128, 11131, 11167, 11192, 11195, 11198, 11223, 11226, 11227, 11229, 11257, 11262, 11645, 11676, 11677, 11678, 11707, 11708, 11711, 11734, 11738, 11741, 11743, 11769, 11773, 11774, 11802, 11803, 11836, 11866, 11890, 11895, 11898, 11902, 11903, 11931, 11933, 11934, 11963, 11964, 11965, 11966, 11967, 11994, 11997, 12027, 12028, 12030, 12054, 12060, 12061, 12062, 12063, 12093, 12126, 12127, 12152, 12155, 12157, 12159, 12187, 12190, 12191, 12215, 12217, 12220, 12222, 12223, 12251, 12253, 12254, 12273, 12277, 12280, 12281, 12284, 12286, 12287, 12702, 12703, 12763, 12765, 12766, 12788, 12793, 12795, 12826, 12831, 12861, 12862, 12863, 12891, 12893, 12894, 12923, 12927, 12955, 12956, 12958, 12959, 12987, 12990, 13018, 13021, 13022, 13050, 13052, 13053, 13078, 13079, 13082, 13083, 13084, 13085, 13118, 13147, 13148, 13149, 13150, 13151, 13179, 13208, 13210, 13212, 13214, 13245, 13247, 13270, 13271, 13275, 13276, 13277, 13278, 13302, 13303, 13304, 13306, 13308, 13309, 13789, 13790, 13791, 13822, 13823, 13881, 13883, 13885, 13886, 13915, 13917, 13918, 13947, 13978, 13980, 13982, 13983, 14032, 14035, 14037, 14040, 14042, 14047, 14078, 14136, 14137, 14138, 14143, 14172, 14173, 14175, 14202, 14203, 14204, 14205, 14206, 14233, 14236, 14237, 14270, 14271, 14291, 14295, 14296, 14300, 14327, 14328, 14329, 14773, 14775, 14776, 14781, 14782, 14809, 14811, 14813, 14814, 14815, 14843, 14845, 14846, 14847, 14877, 14902, 14903, 14911, 14970, 14971, 15001, 15002, 15003, 15004, 15007, 15036, 15037, 15038, 15061, 15070, 15071, 15101, 15102, 15103, 15128, 15131, 15132, 15133, 15163, 15166, 15196, 15199, 15221, 15222, 15224, 15226, 15231, 15253, 15254, 15256, 15257, 15263, 15286, 15288, 15290, 15292, 15293, 15318, 15322, 15323, 15351, 15352, 15353, 15355, 15356, 15798, 15806, 15807, 15834, 15839, 15865, 15866, 15871, 15903, 15928, 15932, 15935, 15961, 15963, 15967, 15984, 15986, 15990, 15995, 16027, 16028, 16029, 16030, 16047, 16052, 16053, 16055, 16056, 16057, 16059, 16060, 16062, 16063, 16126, 16127, 16151, 16152, 16179, 16182, 16184, 16185, 16186, 16187, 16216, 16217, 16219, 16222, 16223, 16250, 16255, 16282, 16283, 16285, 16286, 16287, 16311, 16313, 16314, 16315, 16319, 16342, 16343, 16345, 16346, 16347, 16348, 16349, 16350, 16383, 16830, 16862, 16888, 16894, 16895, 16919, 16921, 16922, 16923, 16926, 16953, 16956, 16957, 16958, 16990, 16991, 17012, 17015, 17018, 17019, 17020, 17021, 17022, 17023, 17055, 17083, 17084, 17110, 17113, 17117, 17145, 17146, 17149, 17151, 17177, 17178, 17205, 17206, 17210, 17211, 17214, 17241, 17242, 17247, 17270, 17275, 17276, 17304, 17309, 17336, 17338, 17341, 17363, 17364, 17372, 17373, 17398, 17400, 17404, 17406, 17407, 17874, 17876, 17877, 17878, 17885, 17886, 17887, 17912, 17913, 17915, 17917, 17918, 17979, 17981, 17982, 18046, 18047, 18071, 18072, 18073, 18076, 18078, 18079, 18108, 18109, 18110, 18111, 18168, 18169, 18170, 18173, 18202, 18205, 18206, 18207, 18227, 18230, 18235, 18261, 18263, 18264, 18265, 18266, 18268, 18269, 18270, 18301, 18302, 18328, 18329, 18330, 18335, 18357, 18358, 18363, 18392, 18394, 18398, 18399, 18422, 18430, 18844, 18845, 18846, 18847, 18908, 18935, 18938, 18940, 18941, 18974, 18975, 19006, 19007, 19028, 19030, 19033, 19034, 19036, 19037, 19071, 19096, 19097, 19098, 19103, 19120, 19124, 19130, 19131, 19134, 19163, 19164, 19165, 19167, 19198, 19199, 19226, 19227, 19230, 19231, 19288, 19290, 19294, 19295, 19318, 19320, 19321, 19322, 19325, 19327, 19353, 19359, 19386, 19388, 19419, 19420, 19423, 19448, 19454, 19871, 19899, 19900, 19901, 19928, 19931, 19932, 19934, 19958, 19961, 19962, 19964, 19965, 19967, 19993, 19994, 19997, 20026, 20028, 20029, 20031, 20051, 20052, 20053, 20054, 20060, 20092, 20093, 20095, 20126, 20127, 20153, 20156, 20157, 20159, 20181, 20183, 20191, 20217, 20218, 20219, 20220, 20221, 20223, 20250, 20251, 20252, 20253, 20254, 20280, 20281, 20282, 20285, 20286, 20287, 20341, 20343, 20345, 20347, 20348, 20349, 20350, 20381, 20412, 20433, 20440, 20443, 20445, 20447, 20470, 20473, 20474, 20478, 20925, 20926, 20927, 20957, 20958, 20986, 20987, 20989, 21019, 21020, 21023, 21045, 21046, 21048, 21054, 21083, 21086, 21087, 21116, 21119, 21143, 21145, 21146, 21150, 21175, 21178, 21181, 21210, 21211, 21213, 21241, 21246, 21276, 21277, 21301, 21304, 21305, 21307, 21308, 21338, 21339, 21343, 21368, 21370, 21371, 21372, 21373, 21374, 21403, 21430, 21431, 21434, 21436, 21437, 21438, 21439, 21471, 21491, 21492, 21495, 21497, 21498, 21500, 21503, 21974, 21977, 22007, 22008, 22009, 22010, 22012, 22015, 22043, 22046, 22075, 22076, 22078, 22100, 22102, 22104, 22105, 22106, 22107, 22108, 22109, 22110, 22111, 22131, 22140, 22141, 22143, 22168, 22170, 22172, 22173, 22200, 22203, 22233, 22236, 22262, 22263, 22266, 22267, 22269, 22271, 22293, 22294, 22296, 22297, 22298, 22299, 22301, 22302, 22332, 22334, 22335, 22366, 22367, 22395, 22421, 22423, 22428, 22453, 22460, 22462, 22463, 22485, 22486, 22487, 22491, 22492, 22493, 22517, 22525, 22526, 22967, 22968, 22969, 22970, 22972, 22975, 22998, 23003, 23005, 23033, 23034, 23035, 23068, 23089, 23093, 23097, 23100, 23101, 23133, 23135, 23158, 23159, 23162, 23190, 23194, 23195, 23197, 23198, 23221, 23222, 23223, 23226, 23227, 23228, 23257, 23261, 23263, 23279, 23292, 23294, 23319, 23320, 23321, 23323, 23324, 23325, 23327, 23353, 23358, 23383, 23384, 23388, 23410, 23412, 23420, 23421, 23422, 23423, 23449, 23453, 23483, 23485, 23486, 23487, 23507, 23514, 23515, 23517, 23545, 23546, 23547, 23548, 23550, 23551, 23996, 23998, 24017, 24019, 24022, 24023, 24026, 24028, 24029, 24031, 24094, 24118, 24123, 24126, 24127, 24148, 24152, 24154, 24155, 24157, 24187, 24188, 24191, 24222, 24223, 24251, 24252, 24253, 24254, 24285, 24308, 24311, 24312, 24315, 24316, 24317, 24318, 24347, 24351, 24379, 24380, 24381, 24383, 24411, 24412, 24413, 24414, 24415, 24446, 24470, 24474, 24475, 24477, 24478, 24479, 24503, 24507, 24510, 24511, 24539, 24541, 24558, 24571, 24573, 25021, 25022, 25051, 25052, 25053, 25076, 25082, 25083, 25084, 25085, 25112, 25115, 25117, 25119, 25142, 25145, 25147, 25149, 25150, 25151, 25172, 25173, 25178, 25179, 25180, 25182, 25208, 25209, 25210, 25212, 25213, 25239, 25242, 25244, 25245, 25247, 25306, 25307, 25308, 25310, 25333, 25337, 25339, 25342, 25343, 25370, 25373, 25374, 25375, 25407, 25434, 25437, 25466, 25467, 25469, 25488, 25490, 25491, 25497, 25499, 25501, 25502, 25553, 25556, 25558, 25559, 25561, 25563, 25564, 25565, 25566, 25567, 25584, 25592, 25597, 25598, 26072, 26073, 26075, 26076, 26077, 26078, 26108, 26111, 26141, 26142, 26171, 26173, 26175, 26194, 26204, 26205, 26206, 26207, 26236, 26237, 26238, 26259, 26262, 26267, 26296, 26297, 26298, 26302, 26303, 26327, 26328, 26333, 26365, 26366, 26393, 26394, 26396, 26397, 26430, 26431, 26454, 26459, 26460, 26463, 26483, 26485, 26490, 26491, 26492, 26520, 26521, 26524, 26525, 26526, 26527, 26555, 26556, 26558, 26559, 26581, 26583, 26585, 26587, 26588, 26589, 26618, 26619, 26621, 26622, 26623, 27068, 27094, 27095, 27098, 27102, 27124, 27128, 27129, 27130, 27133, 27134, 27135, 27157, 27161, 27162, 27192, 27194, 27195, 27196, 27197, 27199, 27213, 27219, 27222, 27223, 27224, 27225, 27227, 27228, 27231, 27258, 27260, 27262, 27263, 27283, 27288, 27289, 27292, 27293, 27295, 27320, 27322, 27325, 27355, 27356, 27357, 27358, 27359, 27383, 27384, 27385, 27387, 27388, 27416, 27417, 27422, 27423, 27442, 27443, 27447, 27452, 27453, 27473, 27474, 27475, 27476, 27478, 27479, 27480, 27481, 27484, 27510, 27511, 27513, 27515, 27516, 27517, 27576, 27581, 27583, 27603, 27606, 27609, 27611, 27612, 27613, 27614, 27644, 27645, 28125, 28127, 28158, 28182, 28183, 28185, 28189, 28191, 28209, 28218, 28219, 28221, 28223, 28251, 28278, 28279, 28280, 28281, 28283, 28285, 28286, 28287, 28315, 28318, 28335, 28337, 28340, 28345, 28347, 28348, 28349, 28350, 28351, 28382, 28405, 28407, 28414, 28415, 28447, 28474, 28475, 28477, 28478, 28507, 28509, 28510, 28511, 28532, 28533, 28534, 28535, 28539, 28542, 28543, 28566, 28567, 28570, 28592, 28593, 28596, 28598, 28600, 28601, 28603, 28630, 28632, 28635, 28663, 28671, 29081, 29082, 29086, 29103, 29106, 29113, 29118, 29119, 29147, 29150, 29167, 29168, 29172, 29174, 29176, 29177, 29180, 29181, 29206, 29208, 29209, 29210, 29212, 29244, 29245, 29246, 29247, 29273, 29276, 29279, 29299, 29300, 29301, 29302, 29304, 29306, 29309, 29311, 29337, 29338, 29339, 29340, 29342, 29397, 29399, 29401, 29402, 29406, 29436, 29437, 29462, 29466, 29468, 29469, 29470, 29471, 29492, 29501, 29502, 29503, 29525, 29527, 29528, 29529, 29530, 29534, 29559, 29560, 29562, 29563, 29565, 29566, 29595, 29597, 29599, 29621, 29622, 29626, 29628, 29652, 29658, 29659, 29660, 29663, 29681, 29683, 29687, 29688, 30142, 30165, 30166, 30167, 30171, 30173, 30175, 30202, 30203, 30204, 30205, 30206, 30207, 30228, 30231, 30233, 30264, 30267, 30268, 30269, 30294, 30298, 30300, 30302, 30303, 30363, 30364, 30365, 30386, 30389, 30393, 30395, 30398, 30399, 30429, 30451, 30459, 30462, 30463, 30485, 30489, 30490, 30491, 30494, 30518, 30520, 30522, 30523, 30548, 30550, 30556, 30587, 30588, 30589, 30590, 30591, 30620, 30622, 30623, 30641, 30643, 30647, 30652, 30653, 30654, 30676, 30677, 30680, 30681, 30703, 30709, 30712, 30713, 30715, 30717, 30718, 31135, 31190, 31193, 31194, 31196, 31197, 31199, 31224, 31226, 31227, 31230, 31231, 31249, 31261, 31262, 31284, 31285, 31295, 31316, 31320, 31327, 31354, 31355, 31381, 31382, 31386, 31388, 31390, 31391, 31404, 31412, 31413, 31414, 31420, 31421, 31450, 31453, 31454, 31476, 31485, 31514, 31516, 31517, 31518, 31538, 31539, 31550, 31567, 31573, 31574, 31578, 31580, 31581, 31582, 31583, 31603, 31605, 31606, 31607, 31609, 31610, 31612, 31614, 31637, 31641, 31645, 31647, 31670, 31671, 31677, 31679, 31705, 31710, 31711, 31733, 31734, 31736, 31738, 31739, 31743, 32181, 32182, 32184, 32188, 32211, 32212, 32214, 32221, 32222, 32223, 32255, 32273, 32274, 32285, 32286, 32287, 32313, 32316, 32318, 32345, 32346, 32350, 32371, 32372, 32374, 32375, 32380, 32381, 32382, 32405, 32406, 32407, 32409, 32413, 32437, 32440, 32443, 32445, 32446, 32447, 32468, 32470, 32476, 32477, 32478, 32479, 32510, 32530, 32531, 32532, 32541, 32543, 32575, 32597, 32598, 32600, 32601, 32602, 32605, 32606, 32627, 32631, 32637, 32638, 32666, 32667, 32671, 32692, 32693, 32694, 32695, 32697, 32698, 32702, 32703, 32720, 32721, 32722, 32724, 32725, 32729, 32732, 32733, 32735};

//////////////////////////////////////////////////////////////////
// LC Calibration
//////////////////////////////////////////////////////////////////
char found_coarse_codes = 0;
char coarse_code_iteration = 0;
char coarse_codes[32];
char coarse_codes_length = 0;

char pass = 1;
char mid0_iteration = 0;
unsigned int mid0_codes[32];

char coarse0_iteration = 0;
unsigned int coarse0_codes[32];
unsigned int cumulative_coarse0_codes[32];

char calibration_hysteresis = 0;
char LC_calibration_finished = 0;
	
//////////////////////////////////////////////////////////////////
// Temperature Function
//////////////////////////////////////////////////////////////////

double temp = 20;

void measure_temperature() {
	// RFCONTROLLER_REG__INT_CONFIG = 0x3FF;   // Enable all interrupts and pulses to radio timer
	// RFCONTROLLER_REG__ERROR_CONFIG = 0x1F;  // Enable all errors
	
	// Enable RF timer interrupt
	ISER = 0x0080;

	RFTIMER_REG__CONTROL = 0x7;
	RFTIMER_REG__MAX_COUNT = 0x0003D090;
	RFTIMER_REG__COMPARE6 = 0x0003D090;
	RFTIMER_REG__COMPARE6_CONTROL = 0x03;

	// Reset all counters
	ANALOG_CFG_REG__0 = 0x0000;

	// Enable all counters
	ANALOG_CFG_REG__0 = 0x3FFF;
}

void measure_counters() {
	// Enable static divider
	divProgram(480, 1, 1);
	
	// Turn on LO, DIV, PA, IF
	ANALOG_CFG_REG__10 = 0x78;
	
	// Turn off polyphase and disable mixer
	ANALOG_CFG_REG__16 = 0x6;
	
	// Enable RF timer interrupt
	ISER = 0x0080;

	RFTIMER_REG__CONTROL = 0x7;
	RFTIMER_REG__MAX_COUNT = 0x0000C350;
	RFTIMER_REG__COMPARE7 = 0x0000C350;
	RFTIMER_REG__COMPARE7_CONTROL = 0x03;

	// Reset all counters
	ANALOG_CFG_REG__0 = 0x0000;

	// Enable all counters
	ANALOG_CFG_REG__0 = 0x3FFF;
}

void test_LC_sweep_tx(void) {
	/*
	Inputs:
	Outputs:
	Note:
		Initialization of the scan settings should already have 
		been performed.
	*/

	int coarse, mid, fine;
	unsigned char iterations = 3;
	unsigned int i;

	// Enable the TX. NB: Requires 50us for frequency settling
	// transient.
	radio_txEnable();
	
	while (1) {
		for (coarse=0; coarse<32; coarse++) {
			for (mid=0; mid<32; mid++) {
				for (fine=0; fine<32; fine++) {
					// Construct the packet 
					// with payload {coarse, mid, fine} in 
					// separate bytes
					send_packet[0] = coarse & 0xFF;
					send_packet[1] = mid & 0xFF;
					send_packet[2] = fine & 0xFF;
					radio_loadPacket(3);

					// Set the LC frequency
					LC_FREQCHANGE(23&0x1F, 15&0x1F, 28&0x1F);

					// TODO: Wait for at least 50us
					for (i=0; i<250; i++) {}

					// Send bits out the radio thrice for redundancy
					for(i=0; i<iterations; i++) {
						radio_txNow();
					}
				}
			}
		}
	}
}

void sweep_LC() {	
	// Enable static divider
	divProgram(480, 1, 1);
	
	// Turn on LO, DIV, PA, IF
	ANALOG_CFG_REG__10 = 0x78;
	
	// Turn off polyphase and disable mixer
	ANALOG_CFG_REG__16 = 0x6;
	
	LC_sweep_code = 0;
	
	LC_FREQCHANGE((LC_sweep_code & 0x7C00) >> 10,
								(LC_sweep_code & 0x3E0) >> 5,
								LC_sweep_code & 0x1F);
	
	// Enable RF timer interrupt
	ISER = 0x0080;

	RFTIMER_REG__CONTROL = 0x7;
	RFTIMER_REG__MAX_COUNT = 0x00004E20;
	RFTIMER_REG__COMPARE7 = 0x00004E20;
	RFTIMER_REG__COMPARE7_CONTROL = 0x03;

	// Reset all counters
	ANALOG_CFG_REG__0 = 0x0000;

	// Enable all counters
	ANALOG_CFG_REG__0 = 0x3FFF;
}

void sweep_LC_monotonic() {
	// Enable static divider
	divProgram(480, 1, 1);
	
	// Turn on LO, DIV, PA, IF
	ANALOG_CFG_REG__10 = 0x78;
	
	// Turn off polyphase and disable mixer
	ANALOG_CFG_REG__16 = 0x6;
	
	LC_monotonic_sweep_index = 0;
	LC_monotonic_sweep_code = LC_monotonic_codes[LC_monotonic_sweep_index];
	
	LC_FREQCHANGE((LC_monotonic_sweep_code & 0x7C00) >> 10,
								(LC_monotonic_sweep_code & 0x3E0) >> 5,
								LC_monotonic_sweep_code & 0x1F);
	
	// Enable RF timer interrupt
	ISER = 0x0080;

	RFTIMER_REG__CONTROL = 0x7;
	RFTIMER_REG__MAX_COUNT = 0x00004E20;
	RFTIMER_REG__COMPARE7 = 0x00004E20;
	RFTIMER_REG__COMPARE7_CONTROL = 0x03;

	// Reset all counters
	ANALOG_CFG_REG__0 = 0x0000;

	// Enable all counters
	ANALOG_CFG_REG__0 = 0x3FFF;
}

//////////////////////////////////////////////////////////////////
// Main Function
//////////////////////////////////////////////////////////////////

int main(void) {
	int t,t2;
	int c, m, f;
	unsigned int calc_crc;

	unsigned int rdata_lsb, rdata_msb, count_LC, count_32k, count_2M;
	
	unsigned char AdvA[6];
	
	printf("Initializing...");
	
	// Set up mote configuration
	initialize_mote_ble();
		
	// Check CRC
	printf("\n-------------------\n");
	printf("Validating program integrity..."); 
	
	calc_crc = crc32c(0x0000,code_length);

	if(calc_crc == crc_value){
		printf("CRC OK\n");
	}
	else{
		printf("\nProgramming Error - CRC DOES NOT MATCH - Halting Execution\n");
		while(1);
	}
	// Debug output
	//printf("\nCode length is %u bytes",code_length); 
	//printf("\nCRC calculated by SCM is: 0x%X",calc_crc);	
	
	printf("Calibrating frequencies...\n");
	
	// For initial calibration, turn on AUX, DIV, LO and IF(RX) or PA(TX)
	// Aux is inverted (0 = on)
	// Memory-mapped LDO control
	// ANALOG_CFG_REG__10 = AUX_EN | DIV_EN | PA_EN | IF_EN | LO_EN | PA_MUX | IF_MUX | LO_MUX
	// For MUX signals, '1' = FSM control, '0' = memory mapped control
	// For EN signals, '1' = turn on LDO
	

	// TX
	if(tx_rx_flag == 0){

		// Calibration counts for 100ms
		// Divide ratio is currently 480
		LC_code = 690; //Starting LC code

		// For TX, target LC freq = 2.402G - 0.25M = 2.40175 GHz
		LC_target = 250187;
		
		// Turn on LO, DIV, PA
		ANALOG_CFG_REG__10 = 0x68;
		
		// Turn off polyphase and disable mixer
		ANALOG_CFG_REG__16 = 0x6;
		
	}
	// RX
	else{
		// For RX, target LC freq = 2.402G - 2.5M = 2.3995 GHz
		LC_target = 250000; 
		
		// Turn on LO, DIV, IF
		ANALOG_CFG_REG__10 = 0x58;
		
		// Enable polyphase and mixers via memory-mapped I/O
		ANALOG_CFG_REG__16 = 0x1;
	}

	// initialize_mote_ble();
	LC_sweep_code = 0;
	LC_FREQCHANGE(0, 15, 0);
	
	// Enable optical SFD interrupt for optical calibration
	ISER = 0x0800;
		
	// Wait for optical cal to finish
	while(optical_cal_finished == 0);
	optical_cal_finished = 0;
	
	printf("Cal complete\n");
	
	// Disable static divider to save power
	divProgram(480,0,0);

	
//	// halt here to debug for getting frequencies right
//	while(1){
//	for(t=0;t<100;t++);
//	}

	// Hard code LO value for TX - works on board #5; 2.402G - 250kHz
	if(tx_rx_flag == 0){
		// LC_monotonic(680);
	}

	// Some more RX setup
	if(tx_rx_flag == 1){
		// BLE RX only works using the 32-bit raw chips shift register receiver
		// So you must know 32-bits at the beginning of the packet to trigger on
		
		//	The contents of the packet this demo code is searching for
		//	blepkt[0] =	0x1D55ADF6;
		//	blepkt[1] =	0x45C7C50E;
		//	blepkt[2] =	0x2613C2AC;
		//	blepkt[3] =	0x9837B830;
		//	blepkt[4] =	0xA1C9E493;
		//	blepkt[5] =	0x75B7416C;
		//	blepkt[6] =	0xD12DB800;
		
		// The packet above includes [preamble Access_Address PDU] (I think...)
		// We want to search for the Access Address (AA) (this assumes we can know this value ahead of time)
		// The AA used in this packet is 0x8E89_BED6
		// But the endianness is flipped for sending so we are searching for 0x6B7D_9171
		
		// Set up the 32-bit value we are searching for
		ANALOG_CFG_REG__1 = 0x9171;	//lsbs
		ANALOG_CFG_REG__2 = 0x6B7D;	//msbs
		
		// The correlation threshold determines whether an interrupt gets thrown
		// For BLE we need 100% correct bits so we set the Hamming distance to 0 here
		acfg3_val = 0x60;
		ANALOG_CFG_REG__3 = acfg3_val;
		
		// Turn on the radio
		radio_rxEnable();
		
		// Hard code the frequency for now
		//LC_FREQCHANGE(21,10,16);
		// LC_FREQCHANGE(23,2,14);
		
		// Enable the raw chips startval interrupt
		// This interrupt will go off when 32-bit value is in the shift register
		// The ISR will then retrieve the packet data and determine if it was valid
		ISER = 0x0100;
	}
	
	// Enable UART interrupt
	ISER = 0x0001; 
	
	AdvA[0] = 0x00;
	AdvA[1] = 0x02;
	AdvA[2] = 0x72;
	AdvA[3] = 0x32;
	AdvA[4] = 0x80;
	AdvA[5] = 0xC6;
	
	/*
	while(1) {
		measure_counters();
		for(t=0; t<200000; t++);
	}
	*/	
	
	// test_LC_sweep_tx();
	
	/*
	while (1) {
		for (f = 0; f < 32; ++f) {
			LC_FREQCHANGE(23, 15, f);
			for(t=0; t<100000; t++);
		}
	}
	*/
	
	/*
	while(1) {
		// Turn on LO and PA
		radio_txEnable();
		
		// Wait for frequency to settle 
		for(t=0; t<5000; t++);
	};
	*/
	
	/*
	// sweep_LC();
	sweep_LC_monotonic();
	while (1) {}
	*/
		
	while(1) {
			
		unsigned char packetBLE[64];
		
		// measure_temperature();
		
		if(tx_rx_flag == 0){
			
			// Create some BLE packet
			gen_test_ble_packet(packetBLE);
			// gen_ble_packet(packetBLE, AdvA, 37);
			
			// Load the packet into the arbitrary TX FIFO
			load_tx_arb_fifo(packetBLE);
			
			// Turn on LO and PA
			radio_txEnable();
			
			// Wait for frequency to settle 
			for(t=0; t<5000; t++);
			
			// Send the packet
			transmit_tx_arb_fifo();
						
			// Wait for transmission to finish
			// Don't know if there is some way to know when this has finished or just busy wait (?)
			for(t=0; t<500000; t++);
			
			// Turn radio back off
			//radio_rfOff();
			
			printf("Transmitted\n");
		}
		
			// Wait  - this sets packet transmission rate
			for(t=0; t<2000; t++);

	}
}
